<!DOCTYPE html>
<html lang="en" x-data="dnsHistoryApp()">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DNS History Archive</title>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900 font-sans min-h-screen">

<div class="max-w-4xl mx-auto py-12 px-4">

    <!-- Header & Domain Input -->
    <div class="text-center mb-12">
        <h1 class="text-4xl font-bold mb-4">DNS History Archive</h1>
        <form @submit.prevent="goToDomain" class="flex justify-center gap-2">
            <input type="text" x-model="domain" placeholder="Enter domain"
                   class="w-1/2 border border-gray-300 rounded px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button type="submit" class="bg-blue-600 text-white px-6 py-3 rounded hover:bg-blue-700 transition">Search</button>
        </form>
    </div>

    <!-- Selected Domain -->
    <template x-if="selectedDomain">
        <div>

            <h2 class="text-xl font-semibold text-center mb-6">
                Domain: <span class="text-blue-600" x-text="selectedDomain"></span>
            </h2>

            <!-- Timeline of Dates -->
            <div class="overflow-x-auto mb-8">
                <div class="flex gap-2">
                    <template x-for="date in dates" :key="date">
                        <div class="flex flex-col items-center cursor-pointer"
                             :class="selectedDay === date ? 'text-white bg-blue-600' : 'text-gray-700 bg-gray-200 hover:bg-gray-300'"
                             @click="loadDay(date)">
                            <span class="px-3 py-1 rounded text-sm font-medium" x-text="date"></span>
                            <span class="text-xs mt-1" x-text="dailyCounts[date] ? dailyCounts[date] + ' records' : ''"></span>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Daily Records -->
            <template x-if="dayData">
                <div class="bg-white border border-gray-300 rounded shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">Snapshot: <span x-text="selectedDay"></span></h3>
                    <div class="mb-4"><strong>Timestamp:</strong> <span x-text="dayData.timestamp"></span></div>
                    <div x-for="[type, records] in Object.entries(dayData.dns_records)" :key="type" class="mb-2">
                        <strong x-text="type"></strong>:
                        <template x-if="records.length">
                            <ul class="ml-4 list-disc">
                                <template x-for="record in records" :key="record">
                                    <li x-text="record"></li>
                                </template>
                            </ul>
                        </template>
                        <template x-if="!records.length">
                            <span class="text-gray-500 ml-2">None</span>
                        </template>
                    </div>
                    <div class="mt-4"><strong>Changes:</strong> <span x-text="dayData.changes"></span></div>
                    <div class="mt-2"><strong>Subdomains:</strong> <span x-text="Object.keys(dayData.subdomains).length"></span></div>
                </div>
            </template>

            <!-- Summary Table -->
            <template x-if="domainSummary && Object.keys(domainSummary).length">
                <div class="mt-8 overflow-x-auto">
                    <table class="min-w-full text-sm border border-gray-300 rounded">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="border px-3 py-2 text-left">Date</th>
                                <th class="border px-3 py-2">A</th>
                                <th class="border px-3 py-2">AAAA</th>
                                <th class="border px-3 py-2">MX</th>
                                <th class="border px-3 py-2">NS</th>
                                <th class="border px-3 py-2">SOA</th>
                                <th class="border px-3 py-2">TXT</th>
                                <th class="border px-3 py-2">Changes</th>
                                <th class="border px-3 py-2">Subdomains</th>
                                <th class="border px-3 py-2">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="[date, summary] in Object.entries(domainSummary)" :key="date">
                                <tr class="hover:bg-blue-50 cursor-pointer" @click="loadDay(date)">
                                    <td class="border px-3 py-1" x-text="date"></td>
                                    <td class="border px-3 py-1" x-text="summary.A"></td>
                                    <td class="border px-3 py-1" x-text="summary.AAAA"></td>
                                    <td class="border px-3 py-1" x-text="summary.MX"></td>
                                    <td class="border px-3 py-1" x-text="summary.NS"></td>
                                    <td class="border px-3 py-1" x-text="summary.SOA"></td>
                                    <td class="border px-3 py-1" x-text="summary.TXT"></td>
                                    <td class="border px-3 py-1" x-text="summary.changes"></td>
                                    <td class="border px-3 py-1" x-text="summary.subdomain_count"></td>
                                    <td class="border px-3 py-1" x-text="summary.total"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </template>

        </div>
    </template>

    <!-- No domain selected -->
    <template x-if="!selectedDomain">
        <div class="text-center text-gray-500 mt-12">Enter a domain to see its DNS history snapshots.</div>
    </template>

</div>

<script>
function dnsHistoryApp() {
    return {
        domain: '',
        selectedDomain: '{{ domain if domain else "" }}',
        selectedDay: '{{ request.args.get("day") if request.args.get("day") else "" }}',
        domainSummary: {{ summary | tojson() if summary else 'null' }},
        dayData: {{ records | tojson() if records else 'null' }},
        dates: {{ all_dates | tojson() if all_dates else '[]' }},
        dailyCounts: {{ daily_counts | tojson() if daily_counts else '{}' }},

        goToDomain() {
            if(this.domain) window.location.href = '/domain/' + this.domain;
        },

        loadDay(date) {
            this.selectedDay = date;
            window.location.href = `/domain/${this.selectedDomain}?day=${date}`;
        }
    }
}
</script>

</body>
</html>
