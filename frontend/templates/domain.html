<!DOCTYPE html>
<html lang="en" x-data="dnsHistoryApp()">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DNS History Archive</title>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans min-h-screen">

<div class="max-w-6xl mx-auto p-4">

    <!-- Top Section: Domain Input and Timeline -->
    <div class="bg-white shadow rounded p-4 mb-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <!-- Input -->
            <form @submit.prevent="goToDomain" class="flex flex-1 gap-2">
                <input type="text" x-model="domain" placeholder="Enter domain"
                       class="flex-1 border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Search</button>
            </form>

            <!-- Selected Domain -->
            <div class="text-center md:text-left mt-2 md:mt-0">
                <span class="font-semibold text-lg text-gray-700">Domain:</span>
                <span class="text-blue-600 font-bold text-lg" x-text="selectedDomain"></span>
            </div>
        </div>

        <!-- Dates Timeline -->
        <div class="mt-4 overflow-x-auto">
            <div class="flex gap-2">
                <template x-for="date in dates" :key="date">
                    <button @click="loadDay(date)"
                            :class="selectedDay === date ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-blue-100'"
                            class="flex-shrink-0 px-3 py-1 rounded text-sm whitespace-nowrap">
                        <span x-text="date"></span>
                        <span class="ml-1 text-xs text-gray-500" x-text="dailyCounts[date] ? dailyCounts[date].changes + ' changes' : ''"></span>
                        <span class="ml-1 text-xs text-gray-500" x-text="dailyCounts[date] ? dailyCounts[date].total + ' total' : ''"></span>
                    </button>
                </template>
            </div>
        </div>
    </div>

    <!-- Daily Data Section -->
    <div class="bg-white shadow rounded p-4">

        
        <template x-if="selectedDay && dayData">
            <div>
                <h2 class="font-bold text-xl mb-4">Data for <span x-text="selectedDay"></span></h2>

                <!-- Notice -->
                <template x-if="dayData.message">
                    <div class="bg-yellow-100 border border-yellow-300 text-yellow-800 p-3 rounded mb-4">
                        <strong>Notice:</strong> <span x-text="dayData.message"></span>
                    </div>
                </template>

                <!-- DNS Records -->
                <div class="space-y-2 text-sm">
                    <div><strong>Timestamp:</strong> <span x-text="dayData.timestamp"></span></div>
                    <div><strong>Changes:</strong> <span x-text="dayData.changes"></span></div>
                    <div><strong>Total Records:</strong> <span x-text="Object.keys(dayData.total).length"></span></div>
                    <div><strong>Subdomains:</strong> <span x-text="Object.keys(dayData.subdomains).length"></span></div>

                    <template x-for="[type, records] in Object.entries(dayData.dns_records)" :key="type">
                        <div>
                            <strong x-text="type"></strong>:
                            <template x-if="records.length">
                                <ul class="ml-4 list-disc">
                                    <template x-for="record in records" :key="record">
                                        <li x-text="record"></li>
                                    </template>
                                </ul>
                            </template>
                            <template x-if="!records.length">
                                <span>None</span>
                            </template>
                        </div>
                    </template>
                </div>
            </div>
        </template>

        <template x-if="!selectedDay">
            <div class="text-gray-500 text-center py-10">Select a date above to view DNS records.</div>
        </template>
    </div>

</div>

<script>
function dnsHistoryApp() {
    return {
        domain: '',
        selectedDomain: '{{ domain if domain else "" }}',
        selectedDay: '{{ request.args.get("day") if request.args.get("day") else "" }}',
        
        dayData: {{ records | tojson() if records else 'null' }},
        domainSummary: {{ summary | tojson() if summary else '{}' }},
        dates: {{ summary.keys() | list | tojson() if summary else '[]' }},
        dailyCounts: {{ summary | tojson() if summary else '{}' }},

        init() {
            if (!this.selectedDay) {
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                this.selectedDay = `${yyyy}-${mm}-${dd}`;

                if (this.dates.includes(this.selectedDay)) {
                    this.loadDay(this.selectedDay);
                }
            }
        },

        goToDomain() {
            if (this.domain) {
                window.location.href = '/domain/' + this.domain;
            }
        },

        loadDay(date) {
            this.selectedDay = date;
        
            const url = new URL(window.location);
            url.searchParams.set('day', date);
            window.history.pushState({}, '', url);
        
            fetch(`/api/domain/${this.selectedDomain}?day=${date}`)
                .then(res => res.json())
                .then(data => {
                    this.dayData = data.records;
                })
                .catch(err => {
                    console.error(err);
                    this.dayData = { message: 'Could not load data for this day.' };
                });
        }

    }
}
</script>
</body>
</html>
